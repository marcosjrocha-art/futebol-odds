<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Backtest Avan√ßado</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">

<!-- MENU √öNICO -->
<div class="p-6 border-b bg-white">
  <div class="flex flex-wrap gap-2">
    <a href="/" class="px-4 py-2 rounded bg-slate-800 text-white hover:bg-slate-700">üè† Odds</a>
    <a href="/modelos" class="px-4 py-2 rounded bg-slate-800 text-white hover:bg-slate-700">üìä Modelos</a>
    <a href="/backtest" class="px-4 py-2 rounded bg-slate-800 text-white hover:bg-slate-700">üß™ Backtest</a>
    <a href="/backtest-avancado" class="px-4 py-2 rounded bg-slate-900 text-white">üìà Avan√ßado</a>
  </div>
</div>

<div class="p-6 max-w-7xl mx-auto">

  <h1 class="text-3xl font-bold mb-2">üìà Backtest Avan√ßado</h1>
  <p class="text-slate-600 mb-6">
    Avalia√ß√£o educacional por <b>liga</b>, <b>mercado</b> e <b>faixas de probabilidade</b>.
    O gr√°fico mostra onde o ML melhora ou piora em rela√ß√£o ao Poisson.
  </p>

  <!-- ALERT -->
  <div id="alert" class="hidden mb-6 p-4 rounded border border-red-300 bg-red-50 text-red-800 text-sm"></div>

  <!-- TOP 5 -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="p-4 rounded-xl border bg-white shadow-sm">
      <h2 class="font-semibold mb-2">‚úÖ Top 5 (onde ML ajuda mais)</h2>
      <ul id="bestList" class="text-sm space-y-2"></ul>
    </div>

    <div class="p-4 rounded-xl border bg-white shadow-sm">
      <h2 class="font-semibold mb-2">‚ö†Ô∏è Top 5 (onde ML piora / n√£o ajuda)</h2>
      <ul id="worstList" class="text-sm space-y-2"></ul>
    </div>
  </div>

  <!-- SELE√á√ÉO -->
  <div class="p-4 rounded-xl border bg-white shadow-sm mb-8">
    <h2 class="font-semibold mb-4">üìä Gr√°fico por liga e mercado</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="text-sm">Liga</label>
        <select id="leagueSelect" class="w-full border rounded px-3 py-2"></select>
      </div>

      <div>
        <label class="text-sm">Mercado</label>
        <select id="marketSelect" class="w-full border rounded px-3 py-2"></select>
      </div>
    </div>

    <!-- PLOT -->
    <div class="mt-4">
      <div id="fileHint" class="text-xs text-slate-500 mb-2 hidden"></div>
      <img id="advPlot" class="rounded-xl border w-full hidden" />
      <div id="noPlotMsg" class="text-sm text-slate-500 italic mt-2">
        Selecione uma liga e um mercado para visualizar o gr√°fico.
      </div>
    </div>
  </div>

  <p class="text-xs text-slate-400">
    Projeto educacional ‚Äî calibra√ß√£o e valida√ß√£o estat√≠stica. N√£o promete lucro.
  </p>
</div>

<script>
const alertBox = document.getElementById("alert");
const bestList = document.getElementById("bestList");
const worstList = document.getElementById("worstList");
const leagueSelect = document.getElementById("leagueSelect");
const marketSelect = document.getElementById("marketSelect");
const plot = document.getElementById("advPlot");
const noPlotMsg = document.getElementById("noPlotMsg");
const fileHint = document.getElementById("fileHint");

// √çndices carregados do CSV (cobertura completa)
let leagueNameByCode = {};      // { "E0": "Premier League", ... }
let marketsByLeague = {};       // { "E0": Set(["1x2_home", ...]), ... }

// CSV parser simples (funciona bem para esse arquivo)
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return [];
  const headers = lines[0].split(",").map(h => h.trim());
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i];
    if (!line) continue;
    const cols = line.split(","); // league_name n√£o costuma ter v√≠rgula
    const obj = {};
    headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
    rows.push(obj);
  }
  return rows;
}

function setAlert(msg) {
  alertBox.textContent = msg;
  alertBox.classList.remove("hidden");
}

function clearAlert() {
  alertBox.classList.add("hidden");
  alertBox.textContent = "";
}

function fillLeagueSelectAll() {
  const leagues = Object.keys(leagueNameByCode).sort();
  leagueSelect.innerHTML = `<option value="">Selecione</option>` +
    leagues.map(code => {
      const name = leagueNameByCode[code] || "";
      const label = name ? `${code} ‚Äî ${name}` : code;
      return `<option value="${code}">${label}</option>`;
    }).join("");
}

function fillMarketSelectForLeague(leagueCode) {
  const set = marketsByLeague[leagueCode];
  const markets = set ? Array.from(set).sort() : [];
  marketSelect.innerHTML = `<option value="">Selecione</option>` +
    markets.map(m => `<option value="${m}">${m}</option>`).join("");
}

function updatePlot() {
  const l = leagueSelect.value;
  const m = marketSelect.value;

  if (!l || !m) {
    fileHint.classList.add("hidden");
    plot.classList.add("hidden");
    noPlotMsg.textContent = "Selecione uma liga e um mercado para visualizar o gr√°fico.";
    noPlotMsg.classList.remove("hidden");
    return;
  }

  const file = `/static/backtest_adv/${l}_${m}_gap_bins.png`;
  fileHint.textContent = `Arquivo: ${l}_${m}_gap_bins.png`;
  fileHint.classList.remove("hidden");

  plot.src = file;

  plot.onload = () => {
    plot.classList.remove("hidden");
    noPlotMsg.classList.add("hidden");
  };

  plot.onerror = () => {
    plot.classList.add("hidden");
    noPlotMsg.textContent = "Gr√°fico ainda n√£o dispon√≠vel para este mercado.";
    noPlotMsg.classList.remove("hidden");
  };
}

// 1) Top 5 via summary.json (como j√° est√°)
fetch("/static/backtest_adv/summary.json")
  .then(r => {
    if (!r.ok) throw new Error("summary.json n√£o encontrado");
    return r.json();
  })
  .then(data => {
    (data.best || []).slice(0, 5).forEach(r => {
      bestList.innerHTML += `
        <li class="border rounded p-2">
          <b>${r.league}</b> ‚Äî ${r.market}<br>
          Œî LogLoss: ${r.delta.logloss.toFixed(4)} ¬∑ n=${r.n}
        </li>`;
    });

    (data.worst || []).slice(0, 5).forEach(r => {
      worstList.innerHTML += `
        <li class="border rounded p-2">
          <b>${r.league}</b> ‚Äî ${r.market}<br>
          Œî LogLoss: ${r.delta.logloss.toFixed(4)} ¬∑ n=${r.n}
        </li>`;
    });
  })
  .catch(err => {
    setAlert("N√£o consegui ler /static/backtest_adv/summary.json");
  });

// 2) Dropdowns completos via metrics_by_league.csv
fetch("/static/backtest_adv/metrics_by_league.csv")
  .then(r => {
    if (!r.ok) throw new Error("metrics_by_league.csv n√£o encontrado");
    return r.text();
  })
  .then(txt => {
    clearAlert();
    const rows = parseCSV(txt);

    rows.forEach(r => {
      const league = (r.league || "").trim();
      const leagueName = (r.league_name || "").trim();
      const market = (r.market || "").trim();

      if (!league || !market) return;

      if (leagueName && !leagueNameByCode[league]) {
        leagueNameByCode[league] = leagueName;
      }
      if (!marketsByLeague[league]) marketsByLeague[league] = new Set();
      marketsByLeague[league].add(market);
    });

    fillLeagueSelectAll();
  })
  .catch(err => {
    setAlert("N√£o consegui ler /static/backtest_adv/metrics_by_league.csv (precisa estar em static/backtest_adv/).");
  });

// Eventos
leagueSelect.addEventListener("change", () => {
  const l = leagueSelect.value;
  // Ao trocar liga, repovoa mercados daquela liga e limpa o gr√°fico
  fillMarketSelectForLeague(l);
  updatePlot();
});

marketSelect.addEventListener("change", updatePlot);
</script>

</body>
</html>
